<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>实现深层次的数据绑定watch</title>
</head>
<body>
<script>
function Observer(data, events, parent, parentKey){
	this.data = data;
	this.events = events || {}; 
	this.parent = parent || {}; 
	this.parentKey = parentKey || '';
	this.walk(data, this.events);
}
Observer.prototype.walk = function(data, events) {
	for(var key in data) {
		if(data.hasOwnProperty(key)){
			if(typeof(data[key]) == 'object'){
				new Observer(data[key], events, this, key)
			};
			this.getSet(key, data[key], events);
		}
	}
}
Observer.prototype.getSet = function(key, val, events) {
	var self = this;
  	Object.defineProperty(this.data, key, {
    	enumerable: true,
    	configurable: true,
    	get: function() {
	      	console.log('你访问了' + key);
	      	return val;
    	},
		set: function(newVal) {
		    console.log('你设置了', key, ',新的值为', newVal);
		    if (newVal !== val) {
		        val = newVal;
		        var parent = self.parent;
		        var parentKey = self.parentKey;
		        while (parent) { // 循环寻找上级触发事件
		          self.$emit(parentKey, newVal);
		          parentKey = parent.parentKey;
		          parent = parent.parent;
		        }
		        self.$emit(key, newVal); //触发当前key事件
	      	}
	      	if (typeof newVal === "object") { //这个key是obj，递归，往key加get、set
	        	return new Observer(newVal, events, this, key);
	      	}
		}
	})
}

Observer.prototype.$watch = function(key, listener) {
	if(!this.events[key]){
		this.events[key] = [];
	};
	this.events[key].push(listener);
}

Observer.prototype.$emit = function() {
	var key = [].shift.call(arguments);
	var data = [].slice.call(arguments);
	if(!this.events[key] || this.events[key].length < 1) return;
	this.events[key].forEach(function(listener){
		listener(data || {})
	})
}
let app = new Observer({
	user: {
		name: {
			fn: "yin",
			ln: "jm"
		},
		age: 18
	},
	address: "成都"
});
app.$watch('user', function() {
	console.log('你改变了user');
});
app.$watch('name', function(){
	console.log('你改变了name');
});
app.$watch('fn', function(){
	console.log('你改变了fn');
});
app.$watch('age', function(){
	console.log('你改变了age');
});
app.data.user.age = 20;
</script>
</body>
</html>